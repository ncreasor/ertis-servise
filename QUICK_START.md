# Быстрый старт - Ertis Service

## Минимальная настройка для запуска

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка .env

Скопируйте `.env.example` в `.env` и отредактируйте:

```bash
cp .env.example .env
```

**Обязательно настройте:**
```env
# Database
DATABASE_URL=mysql+aiomysql://user:password@localhost:3306/ertis_db

# OpenAI (обязательно для AI-функций)
OPENAI_API_KEY=sk-ваш-ключ-openai

# Yandex Maps (обязательно для автокомплита адресов)
YANDEX_MAPS_API_KEY=ваш-ключ-яндекс-карт

# Security (измените в production)
SECRET_KEY=измените-меня-на-длинную-случайную-строку
```

### 3. Создание базы данных MySQL

```sql
CREATE DATABASE ertis_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 4. Запуск

```bash
python run.py
```

Или:

```bash
./start.sh
```

### 5. Открыть документацию

http://localhost:8000/api/docs

---

## Тестирование без фронтенда

### 1. Зарегистрируйте пользователя

**Swagger UI** → `/api/v1/auth/register` → Try it out

```json
{
  "first_name": "Тест",
  "last_name": "Тестов",
  "username": "test",
  "email": "test@test.com",
  "password": "test123"
}
```

### 2. Войдите

**Swagger UI** → `/api/v1/auth/login` → Try it out

```
username: test
password: test123
```

Скопируйте `access_token`

### 3. Авторизуйтесь в Swagger

Нажмите кнопку **Authorize** вверху страницы, вставьте токен

### 4. Получите категории

**Swagger UI** → `/api/v1/categories` → Try it out → Execute

### 5. Создайте заявку

**Swagger UI** → `/api/v1/requests` → Try it out

Заполните:
- `description`: "Тестовая проблема"
- `address`: "Москва, Ленина 1"
- `category_id`: 1 (выберите из списка категорий)
- `photo`: загрузите любое изображение

**AI автоматически:**
- Проанализирует описание
- Определит приоритет по фото (1-5)
- Назначит на сотрудника (если есть)

---

## Демо-данные (опционально)

Для создания тестовых аккаунтов:

1. Откройте `app/main.py`
2. Раскомментируйте строку:
   ```python
   await create_demo_data(session)
   ```
3. Перезапустите сервер

**Будут созданы:**
- Админ: `admin` / `admin123`
- Пользователь: `user` / `user123`

---

## Структура API

```
/api/v1
├── /auth
│   ├── POST /register        # Регистрация
│   ├── POST /login           # Вход
│   └── GET  /me              # Текущий пользователь
│
├── /requests
│   ├── POST   /              # Создать заявку (с фото)
│   ├── GET    /my            # Мои заявки
│   ├── GET    /assigned      # Назначенные (для сотрудников)
│   ├── GET    /              # Все заявки (для админа)
│   ├── PATCH  /{id}/assign   # Назначить на сотрудника
│   ├── PATCH  /{id}/complete # Завершить (с фото решения)
│   ├── PATCH  /{id}/close    # Закрыть заявку
│   └── POST   /{id}/rate     # Оценить работу
│
├── /employees
│   ├── POST   /              # Создать сотрудника (админ)
│   ├── GET    /              # Список сотрудников (админ)
│   ├── GET    /me            # Мой профиль (сотрудник)
│   └── POST   /{id}/upload-photo
│
├── /categories
│   ├── GET    /              # Все категории (публично)
│   └── POST   /              # Создать категорию (админ)
│
├── /statistics
│   ├── GET    /overview      # Общая статистика (админ)
│   ├── GET    /employee/{id} # Статистика сотрудника
│   └── GET    /requests/priority
│
└── /addresses
    ├── GET    /suggest       # Автокомплит адресов
    └── GET    /geocode       # Координаты по адресу
```

---

## Роли

- **USER** - обычный пользователь (создает заявки)
- **EMPLOYEE** - сотрудник ЖКХ (выполняет заявки)
- **HOUSING_ADMIN** - админ ЖКХ (управление)

---

## Что происходит при создании заявки?

1. **Пользователь** загружает фото и описание
2. **GPT-4o-mini** анализирует текст описания
3. **GPT-4o** анализирует фото и определяет приоритет (1-5)
4. **Система** автоматически назначает заявку на подходящего сотрудника
5. **Сотрудник** видит заявку в своем списке
6. **Сотрудник** выполняет и загружает фото решения
7. **Пользователь** оценивает работу (1-5 звезд)
8. **Рейтинг сотрудника** обновляется автоматически

---

## Проверка работы AI

### Тест 1: Низкий приоритет
- Описание: "Лампочка перегорела в подъезде"
- Фото: обычная лампочка
- Ожидаемый приоритет: 1-2

### Тест 2: Высокий приоритет
- Описание: "Прорвало трубу, затопило квартиру"
- Фото: вода на полу
- Ожидаемый приоритет: 4-5

### Тест 3: Средний приоритет
- Описание: "Сломалась ручка на двери"
- Фото: дверная ручка
- Ожидаемый приоритет: 2-3

---

## Troubleshooting

**Ошибка подключения к БД:**
- Проверьте что MySQL запущен
- Проверьте `DATABASE_URL` в `.env`
- Создайте базу данных `ertis_db`

**Ошибка OpenAI API:**
- Проверьте что ключ валидный
- Проверьте баланс на аккаунте OpenAI

**Ошибка Яндекс.Карты:**
- Проверьте ключ API
- Убедитесь что подключен Геокодер API

**Таблицы не создаются:**
- При первом запуске они создаются автоматически
- Проверьте логи в `logs/app.log`

---

## Полезные ссылки

- **Swagger**: http://localhost:8000/api/docs
- **ReDoc**: http://localhost:8000/api/redoc
- **Полная документация**: [API_DOCUMENTATION.md](./API_DOCUMENTATION.md)
- **OpenAI Platform**: https://platform.openai.com/
- **Яндекс.Карты API**: https://developer.tech.yandex.ru/
