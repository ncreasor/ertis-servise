"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI —á–∞—Ç–æ–º
"""
from datetime import datetime
from typing import List, Optional
from openai import AsyncOpenAI
from app.core.config import settings
from app.schemas.chat import ChatMessage
from app.core.logging import get_logger

logger = get_logger()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY) if settings.OPENAI_API_KEY else None

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
SYSTEM_PROMPT = """–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å–µ—Ä–≤–∏—Å–∞ Ertis Service –¥–ª—è –≥–æ—Ä–æ–¥–∞ –ü–∞–≤–ª–æ–¥–∞—Ä, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
Ertis Service - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (–ñ–ö–•).

–¢–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
- –û–±—ä—è—Å–Ω—è—Ç—å –∫–∞–∫ –ø–æ–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏
- –†–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –ø—Ä–æ–±–ª–µ–º (–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –í–æ–¥–æ–ø—Ä–æ–≤–æ–¥, –î–æ—Ä–æ–≥–∏, –ú—É—Å–æ—Ä, –£–±–æ—Ä–∫–∞, –ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ —Å—Ç–∞—Ç—É—Å–∞—Ö –∑–∞—è–≤–æ–∫
- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ —Å–µ—Ä–≤–∏—Å–∞

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ."""


async def get_chat_response(
    user_message: str,
    history: Optional[List[ChatMessage]] = None
) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

    Args:
        user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        history: –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    Returns:
        –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    """
    # Fallback –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if not client or not settings.OPENAI_API_KEY:
        logger.warning("OpenAI API key –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback")
        return get_fallback_response(user_message)

    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è OpenAI
        messages = [
            {"role": "system", "content": SYSTEM_PROMPT}
        ]

        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
        if history:
            for msg in history[-10:]:  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                messages.append({
                    "role": msg.role,
                    "content": msg.content
                })

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messages.append({
            "role": "user",
            "content": user_message
        })

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç OpenAI
        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            max_tokens=500,
            temperature=0.7
        )

        assistant_message = response.choices[0].message.content
        logger.info(f"AI –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è: {user_message[:50]}...")

        return assistant_message

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI: {e}")
        return get_fallback_response(user_message)


def get_fallback_response(user_message: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å fallback –æ—Ç–≤–µ—Ç –±–µ–∑ AI
    """
    msg = user_message.lower()

    if "–∑–∞—è–≤–∫" in msg or "–ø—Ä–æ–±–ª–µ–º" in msg:
        return "–ß—Ç–æ–±—ã –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É' –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã, –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å. üìù"

    if "—Å—Ç–∞—Ç—É—Å" in msg or "–æ—Ç—Å–ª–µ–¥" in msg:
        return "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–≤–æ–∏—Ö –∑–∞—è–≤–æ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫'. –¢–∞–º –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –≤–∞—à–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å —Ç–µ–∫—É—â–∏–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏. üìä"

    if "–∫–∞—Ç–µ–≥–æ—Ä" in msg:
        return "–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å 6 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –ø—Ä–æ–±–ª–µ–º: –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ ‚ö°, –í–æ–¥–æ–ø—Ä–æ–≤–æ–¥ üíß, –î–æ—Ä–æ–≥–∏ üõ£Ô∏è, –ú—É—Å–æ—Ä üóëÔ∏è, –£–±–æ—Ä–∫–∞ üßπ –∏ –ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ üå≥"

    if "–≤—Ä–µ–º—è" in msg or "–±—ã—Å—Ç—Ä" in msg or "–¥–æ–ª–≥–æ" in msg:
        return "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤. –ù–∞—à AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. ‚è±Ô∏è"

    if "—Ä–µ–≥–∏—Å—Ç—Ä" in msg or "–∞–∫–∫–∞—É–Ω—Ç" in msg:
        return "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏! üë§"

    if "–∫–∞—Ä—Ç" in msg:
        return "–í —Ä–∞–∑–¥–µ–ª–µ '–ö–∞—Ä—Ç–∞ –ø—Ä–æ–±–ª–µ–º' –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ –≥–æ—Ä–æ–¥—É –ü–∞–≤–ª–æ–¥–∞—Ä. üó∫Ô∏è"

    if "–ø—Ä–∏–≤–µ—Ç" in msg or "–∑–¥—Ä–∞–≤—Å—Ç–≤" in msg:
        return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã –†–∞–¥ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å–µ—Ä–≤–∏—Å–∞. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"

    if "—Å–ø–∞—Å–∏–±–æ" in msg or "–±–ª–∞–≥–æ–¥–∞—Ä" in msg:
        return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üòä –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å!"

    return "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π. –ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å? ü§î"
